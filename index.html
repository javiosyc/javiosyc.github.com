<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>javio's Blog</title>
  <meta name="author" content="javio">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="javio's Blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="javio's Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">javio's Blog</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-07-08T14:03:20.000Z"><a href="/2013/07/08/vertx_common_util/">7月 8 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/07/08/vertx_common_util/">vertx_common_util</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Logger 
                ...
                import org.vertx.java.core.logging.Logger;
                ....</p>
<pre><code><figure class="highlight"><pre>            <span class="comment">private</span> <span class="comment">Logger</span> <span class="comment">logger;</span>

            <span class="comment">public</span> <span class="comment">void</span> <span class="comment">start()</span> <span class="comment">{</span>
                <span class="comment">logger</span> <span class="comment">=</span> <span class="comment">getContainer()</span>.<span class="comment">getLogger();</span>
                <span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span>
            <span class="comment">}
</pre></figure></code></pre>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-07-08T08:55:17.000Z"><a href="/2013/07/08/vertx_concept_eventbox/">7月 8 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/07/08/vertx_concept_eventbox/">Event Box</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Event Box </p>
<pre><code><figure class="highlight"><pre>Addressing:
            -String
            -Dot-style namespacing recommended
            - e.g. <span class="string">"messages.inbound.A"</span>

Handlers
        -A handler <span class="keyword">is</span> a thing <span class="keyword">that</span> receives messages <span class="keyword">from</span> <span class="keyword">the</span> bus.
        -You register a handler <span class="keyword">at</span> an address.
        -Many different handlers <span class="keyword">from</span> <span class="keyword">the</span> same <span class="keyword">or</span> different verticles 
         can be registered <span class="keyword">at</span> <span class="keyword">the</span> same address.
        -A single handler can be registered <span class="keyword">by</span> <span class="keyword">the</span> verticle <span class="keyword">at</span> many different addresses.

Handler Registration
            EventBus eb = vertx.eventbus();

            Handler&lt;Message&gt; myHandler = new Handle&lt;Message&gt;() {
                public boid handle(Message message)
                System.out.println(<span class="string">"received a message "</span> + message);
            };
            eb.registerHandle(<span class="string">"test.address"</span>,myHandler);

Pub/Sub  (Publish / subscribe messaging)
            The event bus supports publishing messages.
            Messages are published <span class="keyword">to</span> an address.
            Publishing means delivering <span class="keyword">the</span> message <span class="keyword">to</span> all handlers <span class="keyword">that</span> are registered <span class="keyword">at</span> <span class="keyword">that</span> address.
            This <span class="keyword">is</span> <span class="keyword">the</span> familiar publish/subscribe messaging pattern.

P2P (Point <span class="keyword">to</span> point messaging)
        The event bus supports point <span class="keyword">to</span> point messaging.
        Messages are sent <span class="keyword">to</span> an address. 
        This means a message <span class="keyword">is</span> delivered <span class="keyword">to</span> <span class="keyword">at</span> most one <span class="keyword">of</span> <span class="keyword">the</span> handlers registered <span class="keyword">at</span> <span class="keyword">that</span> address.
        If there <span class="keyword">is</span> more than one handler regsitered <span class="keyword">at</span> <span class="keyword">the</span> address,
        one will be chosen using a non-strict <span class="command">round</span>-robin algorithm.

        With point <span class="keyword">to</span> point messaging, an optional reply handler can be specified when sending <span class="keyword">the</span> message. When a message <span class="keyword">is</span> received <span class="keyword">by</span> a recipient, <span class="keyword">and</span> has been processed, <span class="keyword">the</span> recipient can optionally decide <span class="keyword">to</span> reply <span class="keyword">to</span> <span class="keyword">the</span> message.
        If they do so <span class="keyword">that</span> reply handler will be called.
        When <span class="keyword">the</span> reply <span class="keyword">is</span> received <span class="keyword">back</span> <span class="keyword">at</span> <span class="keyword">the</span> sender, <span class="keyword">it</span> too can be replied <span class="keyword">to</span>.
        This can be repeated ad-infinitum, <span class="keyword">and</span> allows a dialog <span class="keyword">to</span> be <span class="keyword">set</span>-up <span class="keyword">between</span> two different verticles. This <span class="keyword">is</span> a common messaging pattern called <span class="keyword">the</span> Request-Response pattern.


    Sender :
            //eb.send
            eb.send(<span class="string">"test.address"</span>,<span class="string">"This is a message"</span> ,new Handler&lt;Message&lt;String&gt;&gt;(){
                public void handle(Message&lt;String&gt; message) {
                    System.our.println(<span class="string">"receuved a reply"</span> + message.body);
                    }
                });

    Receiver:
            Handler&lt;Message&lt;String&gt;&gt; myHandler = new Handler&lt;Message&lt;String&gt;&gt;(){
                public void handle(Message&lt;String&gt; message) {
                System.out.println(<span class="string">"I received a message "</span> +message.body);
                message.reply(<span class="string">"This is a reply"</span>);
                }
            }
            eb.registerHandler(<span class="string">"test.address"</span>,myHandler);

Message Types 
             -String 
             -Primitives
             -Boxed Primitives
             -<span class="type">boolean</span>/Boolean
             -org.vertx.java.core.json.JsonObject
             -org.vertx.java.core.buffer.Buffer

Transient
            All messages <span class="keyword">in</span> <span class="keyword">the</span> event bus are transient, <span class="keyword">and</span> <span class="keyword">in</span> case <span class="keyword">of</span> failure <span class="keyword">of</span> all <span class="keyword">or</span> 
            parts <span class="keyword">of</span> <span class="keyword">the</span> event bus, there <span class="keyword">is</span> a possibility messages will be lost.
            If your <span class="type">application</span> cares <span class="keyword">about</span> lost messages, you should code your handlers <span class="keyword">to</span> be idempotent, <span class="keyword">and</span> your senders <span class="keyword">to</span> retry <span class="keyword">after</span> recovery.

            If you want <span class="keyword">to</span> persist your messages you can use a persistent work queue module <span class="keyword">for</span> <span class="keyword">that</span>.
</pre></figure></code></pre>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-07-08T08:27:16.000Z"><a href="/2013/07/08/vertx_concept_verticle/">7月 8 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/07/08/vertx_concept_verticle/">Verticle</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Verticle
        -unit of deployment
        -Script/Java Class</p>
<p>Verticle run inside a vert.x instance </p>
<p>A single vert.x instance runs inside its own JVM instance.</p>
<p>Concuurency
        -Verticle instance assigned thread/event loop
        -Verticle instance ALWAYS executes on assigned thread
        -Verticles have isolated classloaders and cnnot shared global satae (static members,global variables etc)
        -can write all code assuming single threading</p>
<p>Verticles are executed using the same thread</p>
<p>Every Java verticle must extend the class org.vertx.java.deploy.Verticle. 
You must override the start method - this is called by Vert.x when the verticle is started.</p>
<p>Verticle clean-up</p>
<p>Servers, clients and event bus handlers will be automatically closed when the verticle is stopped. 
However, if you have any other clean-up logic that you want to execute when the verticle is stopped,
you can implement a stop method which will be called when the verticle is undeployed.</p>
<p>Specifying number of instances</p>
<p>By default, when you deploy a verticle only one instance of the verticle is deployed.
If you want more than one instance to be deployed, e.g. so you can scale over your cores better,
you can specify the number of instances as follows:
    container.deployVerticle(&quot;foo.ChildVerticle&quot;, 10);
The above example would deploy 10 instances.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-07-08T06:32:08.000Z"><a href="/2013/07/08/spring_security_filter_2/">7月 8 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/07/08/spring_security_filter_2/">logoutFilter</a></h1>
  

    </header>
    <div class="entry">
      
        <p>1.notices that the URL that is being requested is for logout</p>
<p>2.The filter calls the configured LogoutHandle(implement the LogoutHandler interface)
    SecurityContextLogoutHandler
        invalidates the Servlet session, in the standard Servlet way, calling the invalidate method
        on the HttpSession object and also clearing the SecurityContext from Spring Security
        (JSESSIONID cookie not clear)
    TokenBasedRememberMeServices
        removes the remember-me cookie by setting its age to 0.</p>
<pre><code><figure class="highlight"><pre>JSESSIONID cookie 
        <span class="tag">&lt;<span class="title">security:http</span>&gt;</span>
        ....
        <span class="tag">&lt;<span class="title">security:logout</span> <span class="attribute">delete-cookies</span>=<span class="value">"JSESSIONID"</span>/&gt;</span>.
        ...
        <span class="tag">&lt;/<span class="title">security:http</span>&gt;</span>

To enable the CookieClearingLogoutHandler handler (removes cookies)
</pre></figure></code></pre>
<p>3.calls the LogoutSuccessHandler’s onLogoutSuccess method
            in the default configuration, redirects to a target URL
            The target URL ( default the root of the application) can be configured using </p>
<pre><code><figure class="highlight"><pre>        request parameter 
            <span class="tag">&lt;<span class="title">security:logout</span> <span class="attribute">logout-success-url</span>=<span class="value">"/index"</span> /&gt;</span>

        the referrer header from the request

            <span class="tag">&lt;<span class="title">security:logout</span> <span class="attribute">delete-cookies</span>=<span class="value">"JSESSIONID"</span> <span class="attribute">success-handler-ref</span>=<span class="value">"logoutRedirectToAny"</span>/&gt;</span>
            ...
            <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"logoutRedirectToAny"</span> 
            <span class="attribute">class</span>=<span class="value">"org.springframework.security.web.authentication.logout.SimpleUrlLogoutSuccessHandler"</span>&gt;</span>
            <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"targetUrlParameter"</span> <span class="attribute">value</span>=<span class="value">"redirectTo"</span>/&gt;</span>
            <span class="tag">&lt;/<span class="title">bean</span>&gt;</span>

            request the following URL
            /j_spring_security_logout?redirectTo=http://www.google.com
            You will be logged out and redirected to Google

            The current implementation LogoutSuccessHandler (SimpleUrlLogoutSuccessHandler) 
            extends from AbstractAuthenticationTargetUrlRequestHandler, which is also used by 
            the authentication process to redirect to a determined URL after authenticating successfully
</pre></figure></code></pre>
<p>LogoutFilter extends GenericFilterBean</p>
<pre><code><figure class="highlight"><pre>        ....
        <span class="keyword">private</span> String filterProcessesUrl = <span class="string">"/j_spring_security_logout"</span>;
        <span class="keyword">private</span> final List&lt;LogoutHandler&gt; handlers;
        <span class="keyword">private</span> final LogoutSuccessHandler logoutSuccessHandler;
        ...

        <span class="keyword">public</span> <span class="keyword">void</span> doFilter(ServletRequest req, ServletResponse res, FilterChain chain)
                                    throws IOException, ServletException {
            HttpServletRequest request = (HttpServletRequest) req;
            HttpServletResponse response = (HttpServletResponse) res;


            <span class="comment">//if the request's URL is /j_spring_security_logout</span>
            <span class="keyword">if</span> (requiresLogout(request, response)) {
                Authentication auth = SecurityContextHolder<span class="variable">.getContext</span>()<span class="variable">.getAuthentication</span>();

                <span class="keyword">if</span> (logger<span class="variable">.isDebugEnabled</span>()) {
                    logger<span class="variable">.debug</span>(<span class="string">"Logging out user '"</span> + auth + <span class="string">"' and transferring to logout destination"</span>);
                }

                <span class="keyword">for</span> (LogoutHandler handler : handlers) {
                    handler<span class="variable">.logout</span>(request, response, auth);
                }

                logoutSuccessHandler<span class="variable">.onLogoutSuccess</span>(request, response, auth);
                <span class="keyword">return</span>;
            }

            chain<span class="variable">.doFilter</span>(request, response);
        }

        ....


         <span class="keyword">protected</span> boolean requiresLogout(HttpServletRequest request, HttpServletResponse response) {

             String uri = request<span class="variable">.getRequestURI</span>();
             <span class="keyword">int</span> pathParamIndex = uri<span class="variable">.indexOf</span>(<span class="string">';'</span>);

             <span class="keyword">if</span> (pathParamIndex &gt; <span class="number">0</span>) {
            <span class="comment">// strip everything from the first semi-colon</span>
            uri = uri<span class="variable">.substring</span>(<span class="number">0</span>, pathParamIndex);
            }

            <span class="keyword">int</span> queryParamIndex = uri<span class="variable">.indexOf</span>(<span class="string">'?'</span>);

            <span class="keyword">if</span> (queryParamIndex &gt; <span class="number">0</span>) {

            <span class="comment">// strip everything from the first question mark</span>
            uri = uri<span class="variable">.substring</span>(<span class="number">0</span>, queryParamIndex);
            }

            <span class="keyword">if</span> (<span class="string">""</span><span class="variable">.equals</span>(request<span class="variable">.getContextPath</span>())) {
                <span class="keyword">return</span> uri<span class="variable">.endsWith</span>(filterProcessesUrl);
            }

            <span class="keyword">return</span> uri<span class="variable">.endsWith</span>(request<span class="variable">.getContextPath</span>() + filterProcessesUrl);
        }
</pre></figure></code></pre>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-07-08T05:49:34.000Z"><a href="/2013/07/08/spring_security_filter_1/">7月 8 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/07/08/spring_security_filter_1/">SecurityContextPersistenceFilter</a></h1>
  

    </header>
    <div class="entry">
      
        <ul>
<li>The first security filter that gets hit by the request is SecurityContextPersistenceFilter.</li>
<li>When the request hits this filter, the framework tries to retrieve a SecurityContext from the standard Servlet session 
(javax.servlet.http.HttpSession).</li>
<li><p>If there is not a context in the session, or the session itself is null (that is, it still doesn’t exist because it hasn’t been
created yet), the framework creates a new empty SecurityContext(or, more accurately, an instance of its implementation class SecurityContextImpl).</p>
</li>
<li><p>A new SecurityContext is created and associated to the current thread of execution.</p>
</li>
</ul>
<p>SecurityContextPersistenceFilter</p>
<pre><code><figure class="highlight"><pre>      ....

      static final String FILTER_APPLIED = <span class="string">"__spring_security_scpf_applied"</span><span class="comment">;</span>

      private SecurityContextRepository repo<span class="comment">;</span>

      private boolean forceEagerSessionCreation = false<span class="comment">;</span>

      .....


    public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain)    throws IOException, ServletException {
        HttpServletRequest request = (HttpServletRequest) req<span class="comment">;</span>
        HttpServletResponse response = (HttpServletResponse) res<span class="comment">;</span>

        if (request<span class="preprocessor">.getAttribute</span>(FILTER_APPLIED) != null) {
            // ensure that filter is only applied once per request
            chain<span class="preprocessor">.doFilter</span>(request, response)<span class="comment">;</span>
            return<span class="comment">;</span>
        }

        final boolean debug = logger<span class="preprocessor">.isDebugEnabled</span>()<span class="comment">;</span>

        request<span class="preprocessor">.setAttribute</span>(FILTER_APPLIED, Boolean<span class="preprocessor">.TRUE</span>)<span class="comment">;</span>


        if (forceEagerSessionCreation) {
            HttpSession session = request<span class="preprocessor">.getSession</span>()<span class="comment">;</span>

            if (debug &amp;&amp; session<span class="preprocessor">.isNew</span>()) {
                logger<span class="preprocessor">.debug</span>(<span class="string">"Eagerly created session: "</span> + session<span class="preprocessor">.getId</span>())<span class="comment">;</span>
            }
        }

        HttpRequestResponseHolder holder = new HttpRequestResponseHolder(request, response)<span class="comment">;</span>

        //repo<span class="preprocessor">.loadContext</span>(holder) 
        <span class="comment">/*retrieve a SecurityContext from the standard Servlet session (javax.servlet.http.HttpSession).
          If there is not a context in the session, or the session itself is null (that is, it still doesn’t exist because it
          hasn’t been created yet), the framework creates a new empty SecurityContext(or, more accurately, an instance of its
          implementation class SecurityContextImpl).
        */</span>


        SecurityContext contextBeforeChainExecution = repo<span class="preprocessor">.loadContext</span>(holder)<span class="comment">;</span>

        try {
            SecurityContextHolder<span class="preprocessor">.setContext</span>(contextBeforeChainExecution)<span class="comment">;</span>

            chain<span class="preprocessor">.doFilter</span>(holder<span class="preprocessor">.getRequest</span>(), holder<span class="preprocessor">.getResponse</span>())<span class="comment">;</span>

        } finally {
            SecurityContext contextAfterChainExecution = SecurityContextHolder<span class="preprocessor">.getContext</span>()<span class="comment">;</span>
            // Crucial removal of SecurityContextHolder contents - do this before anything else.
            SecurityContextHolder<span class="preprocessor">.clearContext</span>()<span class="comment">;</span>
            repo<span class="preprocessor">.saveContext</span>(contextAfterChainExecution, holder<span class="preprocessor">.getRequest</span>(), holder<span class="preprocessor">.getResponse</span>())<span class="comment">;</span>
            request<span class="preprocessor">.removeAttribute</span>(FILTER_APPLIED)<span class="comment">;</span>

            if (debug) {
                logger<span class="preprocessor">.debug</span>(<span class="string">"SecurityContextHolder now cleared, as request processing completed"</span>)<span class="comment">;</span>
            }
        }
    }
</pre></figure></code></pre>
<p>HttpSessionSecurityContextRepository implements SecurityContextRepository</p>
<pre><code><figure class="highlight"><pre>        ....
        <span class="keyword">private</span> String springSecurityContextKey = SPRING_SECURITY_CONTEXT_KEY;
        ....

        <span class="keyword">public</span> SecurityContext loadContext(HttpRequestResponseHolder requestResponseHolder) {

               HttpServletRequest request = requestResponseHolder.getRequest();
               HttpServletResponse response = requestResponseHolder.getResponse();
               HttpSession httpSession = request.getSession(<span class="literal">false</span>);

               SecurityContext context = readSecurityContextFromSession(httpSession);

               <span class="keyword">if</span> (context == <span class="literal">null</span>) {
                   <span class="keyword">if</span> (logger.isDebugEnabled()) {
                       logger.<span class="keyword">debug</span>(<span class="string">"No SecurityContext was available from the HttpSession: "</span> + httpSession +<span class="string">". "</span> +
                       <span class="string">"A new one will be created."</span>);
                   }
                   context = generateNewContext();
               }

               requestResponseHolder.setResponse(<span class="keyword">new</span> SaveToSessionResponseWrapper(response, request, httpSession != <span class="literal">null</span>, context));
               <span class="keyword">return</span> context;
        }





        <span class="keyword">private</span> SecurityContext readSecurityContextFromSession(HttpSession httpSession) {

            <span class="keyword">final</span> boolean <span class="keyword">debug</span> = logger.isDebugEnabled();

            <span class="keyword">if</span> (httpSession == <span class="literal">null</span>) {
                <span class="keyword">if</span> (<span class="keyword">debug</span>) {
                    logger.<span class="keyword">debug</span>(<span class="string">"No HttpSession currently exists"</span>);
                }
                <span class="keyword">return</span> <span class="literal">null</span>;
            }

            <span class="comment">// Session exists, so try to obtain a context from it.</span>

            Object contextFromSession = httpSession.getAttribute(springSecurityContextKey);


            <span class="keyword">if</span> (contextFromSession == <span class="literal">null</span>) {
                <span class="keyword">if</span> (<span class="keyword">debug</span>) {
                    logger.<span class="keyword">debug</span>(<span class="string">"HttpSession returned null object for SPRING_SECURITY_CONTEXT"</span>);
                    }
                <span class="keyword">return</span> <span class="literal">null</span>;
                }

                <span class="comment">// We now have the security context object from the session.</span>
                <span class="keyword">if</span> (!(contextFromSession instanceof SecurityContext)) {
                    <span class="keyword">if</span> (logger.isWarnEnabled()) {
                        logger.warn(springSecurityContextKey + <span class="string">" did not contain a SecurityContext but contained: '"</span>
                        + contextFromSession + <span class="string">"'; are you improperly modifying the HttpSession directly "</span>
                        + <span class="string">"(you should always use SecurityContextHolder) or using the HttpSession attribute "</span>
                        + <span class="string">"reserved for this class?"</span>);
                        }
                    <span class="keyword">return</span> <span class="literal">null</span>;
                }

            <span class="keyword">if</span> (<span class="keyword">debug</span>) {
                logger.<span class="keyword">debug</span>(<span class="string">"Obtained a valid SecurityContext from "</span> + springSecurityContextKey + <span class="string">": '"</span> + contextFromSession + <span class="string">"'"</span>);
            }

            <span class="comment">// Everything OK. The only non-null return from this method.</span>
            <span class="keyword">return</span> (SecurityContext) contextFromSession;
        }
</pre></figure></code></pre>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-07-08T03:03:47.000Z"><a href="/2013/07/08/spring_security_service_layer/">7月 8 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/07/08/spring_security_service_layer/">spring_security_service_layer</a></h1>
  

    </header>
    <div class="entry">
      
        <p>security.xml
1.<security:global-method-security secured-annotations="enabled" /></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-07-08T01:49:11.000Z"><a href="/2013/07/08/spring_security_note/">7月 8 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/07/08/spring_security_note/">spring_security_note</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Spring security
    (1) uses Spring Security to access our current user.
            The Authentication object represents all the information we gathered at the time of authentication (username,password, roles, and so on).</p>
<pre><code><figure class="highlight"><pre>            String username = SecurityContextHolder<span class="preprocessor">.getContext</span>()          //o<span class="preprocessor">.s</span><span class="preprocessor">.s</span><span class="preprocessor">.core</span><span class="preprocessor">.context</span><span class="preprocessor">.SecurityContext</span>
                                                   <span class="preprocessor">.getAuthentication</span>() //o<span class="preprocessor">.s</span><span class="preprocessor">.s</span><span class="preprocessor">.core</span><span class="preprocessor">.Authentication</span>
                                                   <span class="preprocessor">.getName</span>()<span class="comment">;            //login user name</span>


            ===============================================================

            SecurityContext context = SecurityContextHolder<span class="preprocessor">.getContext</span>()<span class="comment">;</span>
            Authentication authentication = context<span class="preprocessor">.getAuthentication</span>()<span class="comment">;</span>
            if (authentication == null) {
                return null<span class="comment">;</span>
            }
            String email = authentication<span class="preprocessor">.getName</span>()<span class="comment">;</span>
            return calendarService<span class="preprocessor">.findUserByEmail</span>(email)<span class="comment">;</span>


        note:It should be noted that null checks should always be done on the Authentication object, 
             as it could be null if the user is not logged <span class="keyword">in</span>.


            ===============================================================
            User user = (User)SecurityContextHolder<span class="preprocessor">.getContext</span>()<span class="preprocessor">.getAuthentication</span>()<span class="preprocessor">.getPrincipal</span>()<span class="comment">;</span>
</pre></figure></code></pre>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-07-06T23:56:55.000Z"><a href="/2013/07/07/spring_security_simple_example/">7月 7 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/07/07/spring_security_simple_example/">spring_security_simple_example</a></h1>
  

    </header>
    <div class="entry">
      
        <p>簡單的security 設定檔 
securiy.xml
                <!--excluse /resources/**  -->
                <http pattern="/resources/**" security="none"/></p>
<pre><code><figure class="highlight"><pre>            <span class="comment">&lt;!-- auto-config="true"        使用spring secuirty 一些基本的設定--&gt;</span>
            <span class="comment">&lt;!-- use-expressions="true" 使用SpEL --&gt;</span>
            <span class="tag">&lt;<span class="title">http</span> <span class="attribute">auto-config</span>=<span class="value">"true"</span> <span class="attribute">use-expressions</span>=<span class="value">"true"</span>&gt;</span>

                <span class="comment">&lt;!-- ConfigAttribute : ROLE_ADMIN , ROLE_USER --&gt;</span>
                <span class="comment">&lt;!-- Security Metadata &lt;intercept-url pattern=... access=...  --&gt;</span>
                <span class="tag">&lt;<span class="title">intercept-url</span> <span class="attribute">pattern</span>=<span class="value">"/"</span>            <span class="attribute">access</span>=<span class="value">"permitAll"</span>/&gt;</span>
                <span class="tag">&lt;<span class="title">intercept-url</span> <span class="attribute">pattern</span>=<span class="value">"/login/*"</span>    <span class="attribute">access</span>=<span class="value">"permitAll"</span>/&gt;</span>
                <span class="tag">&lt;<span class="title">intercept-url</span> <span class="attribute">pattern</span>=<span class="value">"/logout"</span>    <span class="attribute">access</span>=<span class="value">"permitAll"</span>/&gt;</span>
                <span class="tag">&lt;<span class="title">intercept-url</span> <span class="attribute">pattern</span>=<span class="value">"/errors/**"</span>    <span class="attribute">access</span>=<span class="value">"permitAll"</span>/&gt;</span>
                <span class="tag">&lt;<span class="title">intercept-url</span> <span class="attribute">pattern</span>=<span class="value">"/events/"</span>    <span class="attribute">access</span>=<span class="value">"hasRole('ROLE_ADMIN')"</span>/&gt;</span>
                <span class="tag">&lt;<span class="title">intercept-url</span> <span class="attribute">pattern</span>=<span class="value">"/admin/**"</span>    <span class="attribute">access</span>=<span class="value">"hasRole('ROLE_ADMIN')"</span>/&gt;</span>
                <span class="tag">&lt;<span class="title">intercept-url</span> <span class="attribute">pattern</span>=<span class="value">"/**"</span>        <span class="attribute">access</span>=<span class="value">"hasRole('ROLE_USER')"</span>/&gt;</span>

                <span class="tag">&lt;<span class="title">access-denied-handler</span> <span class="attribute">error-page</span>=<span class="value">"/errors/403"</span>/&gt;</span>

                <span class="comment">&lt;!-- spring security filter --&gt;</span>
                <span class="tag">&lt;<span class="title">form-login
</span>                        &lt;!<span class="attribute">--</span> <span class="attribute">customer</span> <span class="attribute">login</span> <span class="attribute">use</span> /<span class="attribute">login</span>/<span class="attribute">form</span>
                             <span class="attribute">If</span> <span class="attribute">a</span> <span class="attribute">login</span> <span class="attribute">page</span> <span class="attribute">is</span> <span class="attribute">not</span> <span class="attribute">specified</span>, 
                             <span class="attribute">Spring</span> <span class="attribute">Security</span> <span class="attribute">will</span> <span class="attribute">redirect</span> <span class="attribute">the</span> <span class="attribute">user</span> <span class="attribute">to</span> /<span class="attribute">spring_security_login.</span>
                         <span class="attribute">--</span>&gt;</span>
                        login-page="/login/form"
                        login-processing-url="/login"

                        username-parameter="username"

                        password-parameter="password"
                        authentication-failure-url="/login/form?error"

                        <span class="comment">&lt;!-- default-target-url will be the context root of the application 
                             depending on the user's role 
                             send the user to a different  default-target-url attribute
                             ref controller that processes /default
                        --&gt;</span>
                        default-target-url="/default"/&gt;

                <span class="comment">&lt;!-- spring security filter --&gt;</span>
                <span class="tag">&lt;<span class="title">logout</span> <span class="attribute">logout-success-url</span>=<span class="value">"/login/form?logout"</span>/&gt;</span>
            <span class="tag">&lt;/<span class="title">http</span>&gt;</span>


             <span class="tag">&lt;<span class="title">authentication-manager</span>&gt;</span>
                 <span class="tag">&lt;<span class="title">authentication-provider</span>&gt;</span>
                     <span class="tag">&lt;<span class="title">user-service</span>&gt;</span>
                         <span class="tag">&lt;<span class="title">user</span> <span class="attribute">name</span>=<span class="value">"user"</span>    <span class="attribute">password</span>=<span class="value">"user"</span>    <span class="attribute">authorities</span>=<span class="value">"ROLE_USER"</span>/&gt;</span>
                         <span class="tag">&lt;<span class="title">user</span> <span class="attribute">name</span>=<span class="value">"admin"</span>    <span class="attribute">password</span>=<span class="value">"admin"</span><span class="attribute">authorities</span>=<span class="value">"ROLE_USER,ROLE_ADMIN"</span>/&gt;</span>
                     <span class="tag">&lt;/<span class="title">user-service</span>&gt;</span>
                 <span class="tag">&lt;/<span class="title">authentication-provider</span>&gt;</span>
             <span class="tag">&lt;/<span class="title">authentication-manager</span>&gt;</span>
</pre></figure></code></pre>
<p>DefaultController.java</p>
<pre><code><figure class="highlight"><pre>            <span class="comment">// imports omitted</span>

            <span class="annotation">@Controller</span>
            <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultController</span> {</span>
                <span class="annotation">@RequestMapping</span>(<span class="string">"/default"</span>)
                <span class="keyword">public</span> String defaultAfterLogin(HttpServletRequest request) {

                    <span class="keyword">if</span> (request.isUserInRole(<span class="string">"ROLE_ADMIN"</span>)) {
                        <span class="keyword">return</span> <span class="string">"redirect:/events/"</span>;
                    }
                    <span class="keyword">return</span> <span class="string">"redirect:/"</span>;
                }
            }
</pre></figure></code></pre>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-07-06T13:05:41.000Z"><a href="/2013/07/06/number-format/">7月 6 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/07/06/number-format/">number format</a></h1>
  

    </header>
    <div class="entry">
      
        <p>number format</p>
<pre><code><figure class="highlight"><pre>        ....
        &lt;fmt:formatNumber value=<span class="string">"<span class="subst">${item.PRICE}</span>"</span>  pattern=<span class="string">"#,##0.00"</span>/&gt;
        ....
</pre></figure></code></pre>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-07-06T13:05:41.000Z"><a href="/2013/07/06/spring_security_exception_message/">7月 6 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/07/06/spring_security_exception_message/">get spring security exception message</a></h1>
  

    </header>
    <div class="entry">
      
        <p>jsp</p>
<pre><code><figure class="highlight"><pre><span class="xml">                    <span class="pi">&lt;?xml version="</span><span class="number">1.0</span><span class="xml">" encoding="ISO-</span><span class="number">8859</span><span class="xml">-</span><span class="number">1</span><span class="xml">" ?&gt;
                    <span class="vbscript">&lt;%@ page language=<span class="string">"java"</span> contentType=<span class="string">"text/html; charset=ISO-</span></span><span class="number">8859</span><span class="xml">-</span><span class="number">1</span><span class="xml">" pageEncoding="ISO-</span><span class="number">8859</span><span class="xml">-</span><span class="number">1</span><span class="xml">"%&gt;
                    <span class="vbscript">&lt;%@ taglib prefix=<span class="string">"c"</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/core"</span> %&gt;</span>

                    <span class="tag">&lt;<span class="title">c:set</span> <span class="attribute">var</span>=<span class="value">"pageTitle"</span> <span class="attribute">value</span>=<span class="value">"Please Login"</span> <span class="attribute">scope</span>=<span class="value">"request"</span>/&gt;</span>

                    <span class="tag">&lt;<span class="title">c:url</span> <span class="attribute">value</span>=<span class="value">"/login"</span> <span class="attribute">var</span>=<span class="value">"loginUrl"</span>/&gt;</span>

                    //method must post 
                    <span class="tag">&lt;<span class="title">form</span> <span class="attribute">action</span>=<span class="value">"</span><span class="variable">${loginUrl}</span><span class="xml">" method="post"&gt;

                    // authentication-failure-url attribute, /login/form?error, contains the HTTP parameter error.
                    <span class="tag">&lt;<span class="title">c:if</span> <span class="attribute">test</span>=<span class="value">"</span><span class="variable">${param.error</span><span class="xml"> != null}"&gt;
                        <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"alert alert-error"</span>&gt;</span> Failed to login.
                        <span class="tag">&lt;<span class="title">c:if</span> <span class="attribute">test</span>=<span class="value">"</span><span class="variable">${SPRING_SECURITY_LAST_EXCEPTION</span><span class="xml"> != null}"&gt;

                        // show error message 
                        Reason: <span class="tag">&lt;<span class="title">c:out</span> <span class="attribute">value</span>=<span class="value">"</span><span class="variable">${SPRING_SECURITY_LAST_EXCEPTION.message}</span><span class="xml">" /&gt;
                        <span class="tag">&lt;/<span class="title">c:if</span>&gt;</span>
                        <span class="tag">&lt;/<span class="title">div</span>&gt;</span>
                    <span class="tag">&lt;/<span class="title">c:if</span>&gt;</span>

                    <span class="tag">&lt;<span class="title">c:if</span> <span class="attribute">test</span>=<span class="value">"</span><span class="variable">${param.logout</span><span class="xml"> != null}"&gt;
                        <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"alert alert-success"</span>&gt;</span>You have been logged out.<span class="tag">&lt;/<span class="title">div</span>&gt;</span>
                    <span class="tag">&lt;/<span class="title">c:if</span>&gt;</span>


                    <span class="tag">&lt;<span class="title">label</span> <span class="attribute">for</span>=<span class="value">"username"</span>&gt;</span>Username<span class="tag">&lt;/<span class="title">label</span>&gt;</span>

                    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">id</span>=<span class="value">"username"</span> <span class="attribute">name</span>=<span class="value">"username"</span>/&gt;</span>

                    <span class="tag">&lt;<span class="title">label</span> <span class="attribute">for</span>=<span class="value">"password"</span>&gt;</span>Password<span class="tag">&lt;/<span class="title">label</span>&gt;</span>
                    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"password"</span> <span class="attribute">id</span>=<span class="value">"password"</span> <span class="attribute">name</span>=<span class="value">"password"</span>/&gt;</span>

                    <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"form-actions"</span>&gt;</span>
                        <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"submit"</span> <span class="attribute">class</span>=<span class="value">"btn"</span> <span class="attribute">name</span>=<span class="value">"submit"</span> <span class="attribute">type</span>=<span class="value">"submit"</span> <span class="attribute">value</span>=<span class="value">"Login"</span>/&gt;</span>
                    <span class="tag">&lt;/<span class="title">div</span>&gt;</span>
                    <span class="tag">&lt;/<span class="title">form</span>&gt;</span></span>
</pre></figure></code></pre>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




<nav id="pagination">
  
  
    <a href="/page/2/" class="alignright next">下一頁</a>
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜尋">
    <input type="hidden" name="q" value="site:yoursite.com">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分類</h3>
  <ul class="entry">
  
    <li><a href="/categories/jstl/">jstl</a><small>2</small></li>
  
    <li><a href="/categories/spring/">spring</a><small>6</small></li>
  
    <li><a href="/categories/vertx/">vertx</a><small>3</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">標籤</h3>
  <ul class="entry">
  
    <li><a href="/tags/filter/">filter</a><small>2</small></li>
  
    <li><a href="/tags/jstl/">jstl</a><small>2</small></li>
  
    <li><a href="/tags/spring-1/">spring</a><small>6</small></li>
  
    <li><a href="/tags/spring_security/">spring_security</a><small>6</small></li>
  
    <li><a href="/tags/vertx/">vert.x</a><small>3</small></li>
  
  </ul>
</div>


  

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2013 javio
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>